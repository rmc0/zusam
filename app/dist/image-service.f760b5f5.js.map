{"version":3,"sources":["lazy/exif.js","../node_modules/object-assign/index.js","../node_modules/webworkify/index.js","../node_modules/inherits/inherits_browser.js","../node_modules/multimath/lib/base64decode.js","../node_modules/multimath/lib/wa_detect.js","../node_modules/multimath/index.js","../node_modules/glur/mono16.js","../node_modules/multimath/lib/unsharp_mask/hsl_l16.js","../node_modules/multimath/lib/unsharp_mask/unsharp_mask.js","../node_modules/multimath/lib/unsharp_mask/unsharp_mask_wasm.js","../node_modules/multimath/lib/unsharp_mask/unsharp_mask_wasm_base64.js","../node_modules/multimath/lib/unsharp_mask/index.js","../node_modules/pica/lib/mm_resize/resize_filter_info.js","../node_modules/pica/lib/mm_resize/resize_filter_gen.js","../node_modules/pica/lib/mm_resize/convolve.js","../node_modules/pica/lib/mm_resize/resize.js","../node_modules/pica/lib/mm_resize/resize_wasm.js","../node_modules/pica/lib/mm_resize/convolve_wasm_base64.js","../node_modules/pica/lib/mm_resize/index.js","../node_modules/pica/lib/mathlib.js","../node_modules/pica/lib/pool.js","../node_modules/pica/lib/utils.js","../node_modules/pica/lib/worker.js","../node_modules/pica/lib/stepper.js","../node_modules/pica/lib/tiler.js","../node_modules/pica/index.js","lazy/image-service.js"],"names":["exif","getOrientation","file","callback","reader","FileReader","onload","e","view","DataView","target","result","getUint16","length","byteLength","offset","marker","getUint32","little","tags","i","readAsArrayBuffer","getOwnPropertySymbols","Object","hasOwnProperty","prototype","propIsEnumerable","propertyIsEnumerable","toObject","val","TypeError","shouldUseNative","assign","test1","String","getOwnPropertyNames","test2","fromCharCode","order2","map","n","join","test3","split","forEach","letter","keys","err","module","exports","source","from","symbols","to","s","arguments","key","call","win","filter","x","xpi","Math","PI","sin","cos","FILTER_INFO","require","FIXED_FRAC_BITS","toFixedPoint","num","round","quality","srcSize","destSize","scale","filterFunction","destPixel","srcPixel","srcFirst","srcLast","filterElementSize","floatFilter","fxpFilter","total","pxl","idx","floatVal","filterTotal","filterVal","leftNotEmpty","rightNotEmpty","filterShift","filterSize","scaleInverted","scaleClamped","min","srcWindow","maxFilterElementSize","floor","packedFilter","Int16Array","packedFilterPtr","slowCopy","subarray","set","max","ceil","Float32Array","clampTo8","convolveHorizontally","src","dest","srcW","srcH","destW","filters","r","g","b","a","filterPtr","srcPtr","srcY","destX","srcOffset","destOffset","convolveVertically","createFilters","resetAlpha","dst","width","height","ptr","len","options","toWidth","destH","toHeight","scaleX","scaleY","offsetX","offsetY","Uint8Array","alpha","filtersX","filtersY","tmp","asUint8Array","buffer","IS_LE","Uint32Array","__","copyInt16asLE","target_offset","data","tmp_offset","__align","filtersX_offset","filtersY_offset","alloc_bytes","instance","__instance","mem","__memory","mem32","src32","convolveHV","_convolveHV","name","fn","wasm_fn","wasm_src","inherits","Multimath","mm_unsharp_mask","mm_resize","MathLib","requested_features","__requested_features","features","js","indexOf","wasm","has_wasm","use","resizeAndUnsharp","cache","resize","unsharpAmount","unsharp_mask","unsharpRadius","unsharpThreshold","GC_INTERVAL","Pool","create","idle","available","acquired","lastId","timeoutId","acquire","resource","pop","id","release","lastUsed","Date","now","push","setTimeout","gc","destroy","objClass","obj","toString","isCanvas","element","cname","isImage","limiter","concurrency","active","queue","roll","shift","Promise","resolve","reject","then","cib_quality_name","cib_support","createImageBitmap","document","c","createElement","resizeWidth","resizeHeight","resizeQuality","bitmap","status","close","catch","mathLib","onmessage","ev","opts","postMessage","MIN_INNER_TILE_SIZE","fromWidth","fromHeight","srcTileSize","destTileBorder","minScale","stageCount","log","pow","PIXEL_EPSILON","pixelFloor","nearest","abs","pixelCeil","y","innerX","innerY","toTileWidth","toTileHeight","innerTileWidth","innerTileHeight","Error","tiles","tile","toX","toY","toInnerX","toInnerY","toInnerWidth","toInnerHeight","webworkify","utils","worker","createStages","createRegions","singletones","NEED_SAFARI_FIX","navigator","userAgent","hardwareConcurrency","DEFAULT_PICA_OPTS","DEFAULT_RESIZE_OPTS","CAN_NEW_IMAGE_DATA","CAN_CREATE_IMAGE_BITMAP","workerFabric","value","terminate","window","url","URL","webkitURL","mozURL","msURL","revokeObjectURL","objectURL","Pica","limiter_key","__limit","cib","ww","__workersPool","__mathlib","init","__initPromise","ImageData","Uint8ClampedArray","ImageBitmap","debug","slice","wpool_key","JSON","stringify","initMath","checkCibResize","mathlib","all","isNaN","naturalWidth","naturalHeight","canceled","cancelToken","DEST_TILE_BORDER","toCtx","getContext","Boolean","imageBitmap","drawImage","tmpCanvas","tmpCtx","iData","getImageData","putImageData","invokeResize","w","preload","wasm_nodule","tileAndResize","srcCtx","srcImageBitmap","processTile","srcImageData","globalCompositeOperation","o","toImageData","createImageData","regions","jobs","cleanup","processStages","stages","isLastStage","resizeBuffer","toBlob","canvas","mimeType","blob","asString","atob","toDataURL","asBuffer","charCodeAt","Blob","type","imageService","pica","img","res","handleImage","fileSize","size","iOS","test","MSStream","console","warn","match","orientation","Image","h","nw","nh","createObjectURL","error"],"mappings":"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","file":"image-service.f760b5f5.js","sourceRoot":"../src","sourcesContent":["// https://stackoverflow.com/questions/7584794/accessing-jpeg-exif-rotation-data-in-javascript-on-the-client-side\n// https://stackoverflow.com/questions/17411991/html5-canvas-rotate-image\n// VALUES :\n// -2 : not jpeg\n// -1 : not defined\n//  1 : 0deg\n//  2 : 0deg reversed\n//  3 : 180deg\n//  4 : 180deg reversed\n//  5 : -90deg reversed\n//  6 : -90deg\n//  7 : 90deg reversed\n//  8 : 90deg\nconst exif = {\n  getOrientation: (file, callback) => {\n    let reader = new FileReader();\n    reader.onload = function(e) {\n      let view = new DataView(e.target.result);\n      // if it doesn't start with the jpeg marker\n      if (view.getUint16(0, false) != 0xffd8) {\n        return callback(-2);\n      }\n      let length = view.byteLength,\n        offset = 2;\n      // loop over all segments of data\n      while (offset < length) {\n        // if offset+2 is less than 8, it's undefined\n        if (view.getUint16(offset + 2, false) <= 8) return callback(-1);\n        let marker = view.getUint16(offset, false);\n        offset += 2;\n        // if we have this marker, we should be able to read orientation\n        if (marker == 0xffe1) {\n          if (view.getUint32((offset += 2), false) != 0x45786966) {\n            return callback(-1);\n          }\n          let little = view.getUint16((offset += 6), false) == 0x4949;\n          offset += view.getUint32(offset + 4, little);\n          let tags = view.getUint16(offset, little);\n          offset += 2;\n          for (let i = 0; i < tags; i++) {\n            if (view.getUint16(offset + i * 12, little) == 0x0112) {\n              return callback(view.getUint16(offset + i * 12 + 8, little));\n            }\n          }\n        } else if ((marker & 0xff00) != 0xff00) {\n          // it's undefined if marker is not 0xFF??\n          break;\n        } else {\n          offset += view.getUint16(offset, false);\n        }\n      }\n      return callback(-1);\n    };\n    reader.readAsArrayBuffer(file);\n  }\n};\nexport default exif;\n","/*\nobject-assign\n(c) Sindre Sorhus\n@license MIT\n*/\n\n'use strict';\n/* eslint-disable no-unused-vars */\nvar getOwnPropertySymbols = Object.getOwnPropertySymbols;\nvar hasOwnProperty = Object.prototype.hasOwnProperty;\nvar propIsEnumerable = Object.prototype.propertyIsEnumerable;\n\nfunction toObject(val) {\n\tif (val === null || val === undefined) {\n\t\tthrow new TypeError('Object.assign cannot be called with null or undefined');\n\t}\n\n\treturn Object(val);\n}\n\nfunction shouldUseNative() {\n\ttry {\n\t\tif (!Object.assign) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Detect buggy property enumeration order in older V8 versions.\n\n\t\t// https://bugs.chromium.org/p/v8/issues/detail?id=4118\n\t\tvar test1 = new String('abc');  // eslint-disable-line no-new-wrappers\n\t\ttest1[5] = 'de';\n\t\tif (Object.getOwnPropertyNames(test1)[0] === '5') {\n\t\t\treturn false;\n\t\t}\n\n\t\t// https://bugs.chromium.org/p/v8/issues/detail?id=3056\n\t\tvar test2 = {};\n\t\tfor (var i = 0; i < 10; i++) {\n\t\t\ttest2['_' + String.fromCharCode(i)] = i;\n\t\t}\n\t\tvar order2 = Object.getOwnPropertyNames(test2).map(function (n) {\n\t\t\treturn test2[n];\n\t\t});\n\t\tif (order2.join('') !== '0123456789') {\n\t\t\treturn false;\n\t\t}\n\n\t\t// https://bugs.chromium.org/p/v8/issues/detail?id=3056\n\t\tvar test3 = {};\n\t\t'abcdefghijklmnopqrst'.split('').forEach(function (letter) {\n\t\t\ttest3[letter] = letter;\n\t\t});\n\t\tif (Object.keys(Object.assign({}, test3)).join('') !==\n\t\t\t\t'abcdefghijklmnopqrst') {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t} catch (err) {\n\t\t// We don't expect any of the above to throw, but better to be safe.\n\t\treturn false;\n\t}\n}\n\nmodule.exports = shouldUseNative() ? Object.assign : function (target, source) {\n\tvar from;\n\tvar to = toObject(target);\n\tvar symbols;\n\n\tfor (var s = 1; s < arguments.length; s++) {\n\t\tfrom = Object(arguments[s]);\n\n\t\tfor (var key in from) {\n\t\t\tif (hasOwnProperty.call(from, key)) {\n\t\t\t\tto[key] = from[key];\n\t\t\t}\n\t\t}\n\n\t\tif (getOwnPropertySymbols) {\n\t\t\tsymbols = getOwnPropertySymbols(from);\n\t\t\tfor (var i = 0; i < symbols.length; i++) {\n\t\t\t\tif (propIsEnumerable.call(from, symbols[i])) {\n\t\t\t\t\tto[symbols[i]] = from[symbols[i]];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn to;\n};\n","var bundleFn = arguments[3];\nvar sources = arguments[4];\nvar cache = arguments[5];\n\nvar stringify = JSON.stringify;\n\nmodule.exports = function (fn, options) {\n    var wkey;\n    var cacheKeys = Object.keys(cache);\n\n    for (var i = 0, l = cacheKeys.length; i < l; i++) {\n        var key = cacheKeys[i];\n        var exp = cache[key].exports;\n        // Using babel as a transpiler to use esmodule, the export will always\n        // be an object with the default export as a property of it. To ensure\n        // the existing api and babel esmodule exports are both supported we\n        // check for both\n        if (exp === fn || exp && exp.default === fn) {\n            wkey = key;\n            break;\n        }\n    }\n\n    if (!wkey) {\n        wkey = Math.floor(Math.pow(16, 8) * Math.random()).toString(16);\n        var wcache = {};\n        for (var i = 0, l = cacheKeys.length; i < l; i++) {\n            var key = cacheKeys[i];\n            wcache[key] = key;\n        }\n        sources[wkey] = [\n            'function(require,module,exports){' + fn + '(self); }',\n            wcache\n        ];\n    }\n    var skey = Math.floor(Math.pow(16, 8) * Math.random()).toString(16);\n\n    var scache = {}; scache[wkey] = wkey;\n    sources[skey] = [\n        'function(require,module,exports){' +\n            // try to call default if defined to also support babel esmodule exports\n            'var f = require(' + stringify(wkey) + ');' +\n            '(f.default ? f.default : f)(self);' +\n        '}',\n        scache\n    ];\n\n    var workerSources = {};\n    resolveSources(skey);\n\n    function resolveSources(key) {\n        workerSources[key] = true;\n\n        for (var depPath in sources[key][1]) {\n            var depKey = sources[key][1][depPath];\n            if (!workerSources[depKey]) {\n                resolveSources(depKey);\n            }\n        }\n    }\n\n    var src = '(' + bundleFn + ')({'\n        + Object.keys(workerSources).map(function (key) {\n            return stringify(key) + ':['\n                + sources[key][0]\n                + ',' + stringify(sources[key][1]) + ']'\n            ;\n        }).join(',')\n        + '},{},[' + stringify(skey) + '])'\n    ;\n\n    var URL = window.URL || window.webkitURL || window.mozURL || window.msURL;\n\n    var blob = new Blob([src], { type: 'text/javascript' });\n    if (options && options.bare) { return blob; }\n    var workerUrl = URL.createObjectURL(blob);\n    var worker = new Worker(workerUrl);\n    worker.objectURL = workerUrl;\n    return worker;\n};\n","if (typeof Object.create === 'function') {\n  // implementation from standard node.js 'util' module\n  module.exports = function inherits(ctor, superCtor) {\n    if (superCtor) {\n      ctor.super_ = superCtor\n      ctor.prototype = Object.create(superCtor.prototype, {\n        constructor: {\n          value: ctor,\n          enumerable: false,\n          writable: true,\n          configurable: true\n        }\n      })\n    }\n  };\n} else {\n  // old school shim for old browsers\n  module.exports = function inherits(ctor, superCtor) {\n    if (superCtor) {\n      ctor.super_ = superCtor\n      var TempCtor = function () {}\n      TempCtor.prototype = superCtor.prototype\n      ctor.prototype = new TempCtor()\n      ctor.prototype.constructor = ctor\n    }\n  }\n}\n","// base64 decode str -> Uint8Array, to load WA modules\n//\n'use strict';\n\n\nvar BASE64_MAP = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\n\n\nmodule.exports = function base64decode(str) {\n  var input = str.replace(/[\\r\\n=]/g, ''), // remove CR/LF & padding to simplify scan\n      max   = input.length;\n\n  var out = new Uint8Array((max * 3) >> 2);\n\n  // Collect by 6*4 bits (3 bytes)\n\n  var bits = 0;\n  var ptr  = 0;\n\n  for (var idx = 0; idx < max; idx++) {\n    if ((idx % 4 === 0) && idx) {\n      out[ptr++] = (bits >> 16) & 0xFF;\n      out[ptr++] = (bits >> 8) & 0xFF;\n      out[ptr++] = bits & 0xFF;\n    }\n\n    bits = (bits << 6) | BASE64_MAP.indexOf(input.charAt(idx));\n  }\n\n  // Dump tail\n\n  var tailbits = (max % 4) * 6;\n\n  if (tailbits === 0) {\n    out[ptr++] = (bits >> 16) & 0xFF;\n    out[ptr++] = (bits >> 8) & 0xFF;\n    out[ptr++] = bits & 0xFF;\n  } else if (tailbits === 18) {\n    out[ptr++] = (bits >> 10) & 0xFF;\n    out[ptr++] = (bits >> 2) & 0xFF;\n  } else if (tailbits === 12) {\n    out[ptr++] = (bits >> 4) & 0xFF;\n  }\n\n  return out;\n};\n","// Detect WebAssembly support.\n// - Check global WebAssembly object\n// - Try to load simple module (can be disabled via CSP)\n//\n'use strict';\n\n\nvar wa;\n\n\nmodule.exports = function hasWebAssembly() {\n  // use cache if called before;\n  if (typeof wa !== 'undefined') return wa;\n\n  wa = false;\n\n  if (typeof WebAssembly === 'undefined') return wa;\n\n  // If WebAssenbly is disabled, code can throw on compile\n  try {\n    // https://github.com/brion/min-wasm-fail/blob/master/min-wasm-fail.in.js\n    // Additional check that WA internals are correct\n\n    /* eslint-disable comma-spacing, max-len */\n    var bin      = new Uint8Array([ 0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11 ]);\n    var module   = new WebAssembly.Module(bin);\n    var instance = new WebAssembly.Instance(module, {});\n\n    // test storing to and loading from a non-zero location via a parameter.\n    // Safari on iOS 11.2.5 returns 0 unexpectedly at non-zero locations\n    if (instance.exports.test(4) !== 0) wa = true;\n\n    return wa;\n  } catch (__) {}\n\n  return wa;\n};\n","'use strict';\n\n\nvar assign         = require('object-assign');\nvar base64decode   = require('./lib/base64decode');\nvar hasWebAssembly = require('./lib/wa_detect');\n\n\nvar DEFAULT_OPTIONS = {\n  js: true,\n  wasm: true\n};\n\n\nfunction MultiMath(options) {\n  if (!(this instanceof MultiMath)) return new MultiMath(options);\n\n  var opts = assign({}, DEFAULT_OPTIONS, options || {});\n\n  this.options         = opts;\n\n  this.__cache         = {};\n\n  this.__init_promise  = null;\n  this.__modules       = opts.modules || {};\n  this.__memory        = null;\n  this.__wasm          = {};\n\n  this.__isLE = ((new Uint32Array((new Uint8Array([ 1, 0, 0, 0 ])).buffer))[0] === 1);\n\n  if (!this.options.js && !this.options.wasm) {\n    throw new Error('mathlib: at least \"js\" or \"wasm\" should be enabled');\n  }\n}\n\n\nMultiMath.prototype.has_wasm = hasWebAssembly;\n\n\nMultiMath.prototype.use = function (module) {\n  this.__modules[module.name] = module;\n\n  // Pin the best possible implementation\n  if (this.options.wasm && this.has_wasm() && module.wasm_fn) {\n    this[module.name] = module.wasm_fn;\n  } else {\n    this[module.name] = module.fn;\n  }\n\n  return this;\n};\n\n\nMultiMath.prototype.init = function () {\n  if (this.__init_promise) return this.__init_promise;\n\n  if (!this.options.js && this.options.wasm && !this.has_wasm()) {\n    return Promise.reject(new Error('mathlib: only \"wasm\" was enabled, but it\\'s not supported'));\n  }\n\n  var self = this;\n\n  this.__init_promise = Promise.all(Object.keys(self.__modules).map(function (name) {\n    var module = self.__modules[name];\n\n    if (!self.options.wasm || !self.has_wasm() || !module.wasm_fn) return null;\n\n    // If already compiled - exit\n    if (self.__wasm[name]) return null;\n\n    // Compile wasm source\n    return WebAssembly.compile(self.__base64decode(module.wasm_src))\n      .then(function (m) { self.__wasm[name] = m; });\n  }))\n    .then(function () { return self; });\n\n  return this.__init_promise;\n};\n\n\n////////////////////////////////////////////////////////////////////////////////\n// Methods below are for internal use from plugins\n\n\n// Simple decode base64 to typed array. Useful to load embedded webassembly\n// code. You probably don't need to call this method directly.\n//\nMultiMath.prototype.__base64decode = base64decode;\n\n\n// Increase current memory to include specified number of bytes. Do nothing if\n// size is already ok. You probably don't need to call this method directly,\n// because it will be invoked from `.__instance()`.\n//\nMultiMath.prototype.__reallocate = function mem_grow_to(bytes) {\n  if (!this.__memory) {\n    this.__memory = new WebAssembly.Memory({\n      initial: Math.ceil(bytes / (64 * 1024))\n    });\n    return this.__memory;\n  }\n\n  var mem_size = this.__memory.buffer.byteLength;\n\n  if (mem_size < bytes) {\n    this.__memory.grow(Math.ceil((bytes - mem_size) / (64 * 1024)));\n  }\n\n  return this.__memory;\n};\n\n\n// Returns instantinated webassembly item by name, with specified memory size\n// and environment.\n// - use cache if available\n// - do sync module init, if async init was not called earlier\n// - allocate memory if not enougth\n// - can export functions to webassembly via \"env_extra\",\n//   for example, { exp: Math.exp }\n//\nMultiMath.prototype.__instance = function instance(name, memsize, env_extra) {\n  if (memsize) this.__reallocate(memsize);\n\n  // If .init() was not called, do sync compile\n  if (!this.__wasm[name]) {\n    var module = this.__modules[name];\n    this.__wasm[name] = new WebAssembly.Module(this.__base64decode(module.wasm_src));\n  }\n\n  if (!this.__cache[name]) {\n    var env_base = {\n      memoryBase: 0,\n      memory: this.__memory,\n      tableBase: 0,\n      table: new WebAssembly.Table({ initial: 0, element: 'anyfunc' })\n    };\n\n    this.__cache[name] = new WebAssembly.Instance(this.__wasm[name], {\n      env: assign(env_base, env_extra || {})\n    });\n  }\n\n  return this.__cache[name];\n};\n\n\n// Helper to calculate memory aligh for pointers. Webassembly does not require\n// this, but you may wish to experiment. Default base = 8;\n//\nMultiMath.prototype.__align = function align(number, base) {\n  base = base || 8;\n  var reminder = number % base;\n  return number + (reminder ? base - reminder : 0);\n};\n\n\nmodule.exports = MultiMath;\n","// Calculate Gaussian blur of an image using IIR filter\n// The method is taken from Intel's white paper and code example attached to it:\n// https://software.intel.com/en-us/articles/iir-gaussian-blur-filter\n// -implementation-using-intel-advanced-vector-extensions\n\nvar a0, a1, a2, a3, b1, b2, left_corner, right_corner;\n\nfunction gaussCoef(sigma) {\n  if (sigma < 0.5) {\n    sigma = 0.5;\n  }\n\n  var a = Math.exp(0.726 * 0.726) / sigma,\n      g1 = Math.exp(-a),\n      g2 = Math.exp(-2 * a),\n      k = (1 - g1) * (1 - g1) / (1 + 2 * a * g1 - g2);\n\n  a0 = k;\n  a1 = k * (a - 1) * g1;\n  a2 = k * (a + 1) * g1;\n  a3 = -k * g2;\n  b1 = 2 * g1;\n  b2 = -g2;\n  left_corner = (a0 + a1) / (1 - b1 - b2);\n  right_corner = (a2 + a3) / (1 - b1 - b2);\n\n  // Attempt to force type to FP32.\n  return new Float32Array([ a0, a1, a2, a3, b1, b2, left_corner, right_corner ]);\n}\n\nfunction convolveMono16(src, out, line, coeff, width, height) {\n  // takes src image and writes the blurred and transposed result into out\n\n  var prev_src, curr_src, curr_out, prev_out, prev_prev_out;\n  var src_index, out_index, line_index;\n  var i, j;\n  var coeff_a0, coeff_a1, coeff_b1, coeff_b2;\n\n  for (i = 0; i < height; i++) {\n    src_index = i * width;\n    out_index = i;\n    line_index = 0;\n\n    // left to right\n    prev_src = src[src_index];\n    prev_prev_out = prev_src * coeff[6];\n    prev_out = prev_prev_out;\n\n    coeff_a0 = coeff[0];\n    coeff_a1 = coeff[1];\n    coeff_b1 = coeff[4];\n    coeff_b2 = coeff[5];\n\n    for (j = 0; j < width; j++) {\n      curr_src = src[src_index];\n\n      curr_out = curr_src * coeff_a0 +\n                 prev_src * coeff_a1 +\n                 prev_out * coeff_b1 +\n                 prev_prev_out * coeff_b2;\n\n      prev_prev_out = prev_out;\n      prev_out = curr_out;\n      prev_src = curr_src;\n\n      line[line_index] = prev_out;\n      line_index++;\n      src_index++;\n    }\n\n    src_index--;\n    line_index--;\n    out_index += height * (width - 1);\n\n    // right to left\n    prev_src = src[src_index];\n    prev_prev_out = prev_src * coeff[7];\n    prev_out = prev_prev_out;\n    curr_src = prev_src;\n\n    coeff_a0 = coeff[2];\n    coeff_a1 = coeff[3];\n\n    for (j = width - 1; j >= 0; j--) {\n      curr_out = curr_src * coeff_a0 +\n                 prev_src * coeff_a1 +\n                 prev_out * coeff_b1 +\n                 prev_prev_out * coeff_b2;\n\n      prev_prev_out = prev_out;\n      prev_out = curr_out;\n\n      prev_src = curr_src;\n      curr_src = src[src_index];\n\n      out[out_index] = line[line_index] + prev_out;\n\n      src_index--;\n      line_index--;\n      out_index -= height;\n    }\n  }\n}\n\n\nfunction blurMono16(src, width, height, radius) {\n  // Quick exit on zero radius\n  if (!radius) { return; }\n\n  var out      = new Uint16Array(src.length),\n      tmp_line = new Float32Array(Math.max(width, height));\n\n  var coeff = gaussCoef(radius);\n\n  convolveMono16(src, out, tmp_line, coeff, width, height, radius);\n  convolveMono16(out, src, tmp_line, coeff, height, width, radius);\n}\n\nmodule.exports = blurMono16;\n","// Calculates 16-bit precision HSL lightness from 8-bit rgba buffer\n//\n'use strict';\n\n\nmodule.exports = function hsl_l16_js(img, width, height) {\n  var size = width * height;\n  var out = new Uint16Array(size);\n  var r, g, b, min, max;\n  for (var i = 0; i < size; i++) {\n    r = img[4 * i];\n    g = img[4 * i + 1];\n    b = img[4 * i + 2];\n    max = (r >= g && r >= b) ? r : (g >= b && g >= r) ? g : b;\n    min = (r <= g && r <= b) ? r : (g <= b && g <= r) ? g : b;\n    out[i] = (max + min) * 257 >> 1;\n  }\n  return out;\n};\n","// Unsharp mask filter\n//\n// http://stackoverflow.com/a/23322820/1031804\n// USM(O) = O + (2 * (Amount / 100) * (O - GB))\n// GB - gaussian blur.\n//\n// Image is converted from RGB to HSL, unsharp mask is applied to the\n// lightness channel and then image is converted back to RGB.\n//\n'use strict';\n\n\nvar glur_mono16 = require('glur/mono16');\nvar hsl_l16     = require('./hsl_l16');\n\n\nmodule.exports = function unsharp(img, width, height, amount, radius, threshold) {\n  var r, g, b;\n  var h, s, l;\n  var min, max;\n  var m1, m2, hShifted;\n  var diff, iTimes4;\n\n  if (amount === 0 || radius < 0.5) {\n    return;\n  }\n  if (radius > 2.0) {\n    radius = 2.0;\n  }\n\n  var lightness = hsl_l16(img, width, height);\n\n  var blured = new Uint16Array(lightness); // copy, because blur modify src\n\n  glur_mono16(blured, width, height, radius);\n\n  var amountFp = (amount / 100 * 0x1000 + 0.5)|0;\n  var thresholdFp = (threshold * 257)|0;\n\n  var size = width * height;\n\n  /* eslint-disable indent */\n  for (var i = 0; i < size; i++) {\n    diff = 2 * (lightness[i] - blured[i]);\n\n    if (Math.abs(diff) >= thresholdFp) {\n      iTimes4 = i * 4;\n      r = img[iTimes4];\n      g = img[iTimes4 + 1];\n      b = img[iTimes4 + 2];\n\n      // convert RGB to HSL\n      // take RGB, 8-bit unsigned integer per each channel\n      // save HSL, H and L are 16-bit unsigned integers, S is 12-bit unsigned integer\n      // math is taken from here: http://www.easyrgb.com/index.php?X=MATH&H=18\n      // and adopted to be integer (fixed point in fact) for sake of performance\n      max = (r >= g && r >= b) ? r : (g >= r && g >= b) ? g : b; // min and max are in [0..0xff]\n      min = (r <= g && r <= b) ? r : (g <= r && g <= b) ? g : b;\n      l = (max + min) * 257 >> 1; // l is in [0..0xffff] that is caused by multiplication by 257\n\n      if (min === max) {\n        h = s = 0;\n      } else {\n        s = (l <= 0x7fff) ?\n          (((max - min) * 0xfff) / (max + min))|0 :\n          (((max - min) * 0xfff) / (2 * 0xff - max - min))|0; // s is in [0..0xfff]\n        // h could be less 0, it will be fixed in backward conversion to RGB, |h| <= 0xffff / 6\n        h = (r === max) ? (((g - b) * 0xffff) / (6 * (max - min)))|0\n          : (g === max) ? 0x5555 + ((((b - r) * 0xffff) / (6 * (max - min)))|0) // 0x5555 == 0xffff / 3\n          : 0xaaaa + ((((r - g) * 0xffff) / (6 * (max - min)))|0); // 0xaaaa == 0xffff * 2 / 3\n      }\n\n      // add unsharp mask mask to the lightness channel\n      l += (amountFp * diff + 0x800) >> 12;\n      if (l > 0xffff) {\n        l = 0xffff;\n      } else if (l < 0) {\n        l = 0;\n      }\n\n      // convert HSL back to RGB\n      // for information about math look above\n      if (s === 0) {\n        r = g = b = l >> 8;\n      } else {\n        m2 = (l <= 0x7fff) ? (l * (0x1000 + s) + 0x800) >> 12 :\n          l  + (((0xffff - l) * s + 0x800) >>  12);\n        m1 = 2 * l - m2 >> 8;\n        m2 >>= 8;\n        // save result to RGB channels\n        // R channel\n        hShifted = (h + 0x5555) & 0xffff; // 0x5555 == 0xffff / 3\n        r = (hShifted >= 0xaaaa) ? m1 // 0xaaaa == 0xffff * 2 / 3\n          : (hShifted >= 0x7fff) ?  m1 + ((m2 - m1) * 6 * (0xaaaa - hShifted) + 0x8000 >> 16)\n          : (hShifted >= 0x2aaa) ? m2 // 0x2aaa == 0xffff / 6\n          : m1 + ((m2 - m1) * 6 * hShifted + 0x8000 >> 16);\n        // G channel\n        hShifted = h & 0xffff;\n        g = (hShifted >= 0xaaaa) ? m1 // 0xaaaa == 0xffff * 2 / 3\n          : (hShifted >= 0x7fff) ?  m1 + ((m2 - m1) * 6 * (0xaaaa - hShifted) + 0x8000 >> 16)\n          : (hShifted >= 0x2aaa) ? m2 // 0x2aaa == 0xffff / 6\n          : m1 + ((m2 - m1) * 6 * hShifted + 0x8000 >> 16);\n        // B channel\n        hShifted = (h - 0x5555) & 0xffff;\n        b = (hShifted >= 0xaaaa) ? m1 // 0xaaaa == 0xffff * 2 / 3\n          : (hShifted >= 0x7fff) ?  m1 + ((m2 - m1) * 6 * (0xaaaa - hShifted) + 0x8000 >> 16)\n          : (hShifted >= 0x2aaa) ? m2 // 0x2aaa == 0xffff / 6\n          : m1 + ((m2 - m1) * 6 * hShifted + 0x8000 >> 16);\n      }\n\n      img[iTimes4] = r;\n      img[iTimes4 + 1] = g;\n      img[iTimes4 + 2] = b;\n    }\n  }\n};\n","'use strict';\n\n\nmodule.exports = function unsharp(img, width, height, amount, radius, threshold) {\n  if (amount === 0 || radius < 0.5) {\n    return;\n  }\n\n  if (radius > 2.0) {\n    radius = 2.0;\n  }\n\n  var pixels = width * height;\n\n  var img_bytes_cnt        = pixels * 4;\n  var hsl_bytes_cnt        = pixels * 2;\n  var blur_bytes_cnt       = pixels * 2;\n  var blur_line_byte_cnt   = Math.max(width, height) * 4; // float32 array\n  var blur_coeffs_byte_cnt = 8 * 4; // float32 array\n\n  var img_offset         = 0;\n  var hsl_offset         = img_bytes_cnt;\n  var blur_offset        = hsl_offset + hsl_bytes_cnt;\n  var blur_tmp_offset    = blur_offset + blur_bytes_cnt;\n  var blur_line_offset   = blur_tmp_offset + blur_bytes_cnt;\n  var blur_coeffs_offset = blur_line_offset + blur_line_byte_cnt;\n\n  var instance = this.__instance(\n    'unsharp_mask',\n    img_bytes_cnt + hsl_bytes_cnt + blur_bytes_cnt * 2 + blur_line_byte_cnt + blur_coeffs_byte_cnt,\n    { exp: Math.exp }\n  );\n\n  // 32-bit copy is much faster in chrome\n  var img32 = new Uint32Array(img.buffer);\n  var mem32 = new Uint32Array(this.__memory.buffer);\n  mem32.set(img32);\n\n  // HSL\n  var fn = instance.exports.hsl_l16 || instance.exports._hsl_l16;\n  fn(img_offset, hsl_offset, width, height);\n\n  // BLUR\n  fn = instance.exports.blurMono16 || instance.exports._blurMono16;\n  fn(hsl_offset, blur_offset, blur_tmp_offset,\n    blur_line_offset, blur_coeffs_offset, width, height, radius);\n\n  // UNSHARP\n  fn = instance.exports.unsharp || instance.exports._unsharp;\n  fn(img_offset, img_offset, hsl_offset,\n    blur_offset, width, height, amount, threshold);\n\n  // 32-bit copy is much faster in chrome\n  img32.set(new Uint32Array(this.__memory.buffer, 0, pixels));\n};\n","// This is autogenerated file from math.wasm, don't edit.\n//\n'use strict';\n\n/* eslint-disable max-len */\nmodule.exports = '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';\n","'use strict';\n\nmodule.exports = {\n  name:     'unsharp_mask',\n  fn:       require('./unsharp_mask'),\n  wasm_fn:  require('./unsharp_mask_wasm'),\n  wasm_src: require('./unsharp_mask_wasm_base64')\n};\n","// Filter definitions to build tables for\n// resizing convolvers.\n//\n// Presets for quality 0..3. Filter functions + window size\n//\n'use strict';\n\n\nmodule.exports = [\n  { // Nearest neibor (Box)\n    win: 0.5,\n    filter: function (x) {\n      return (x >= -0.5 && x < 0.5) ? 1.0 : 0.0;\n    }\n  },\n  { // Hamming\n    win: 1.0,\n    filter: function (x) {\n      if (x <= -1.0 || x >= 1.0) { return 0.0; }\n      if (x > -1.19209290E-07 && x < 1.19209290E-07) { return 1.0; }\n      var xpi = x * Math.PI;\n      return ((Math.sin(xpi) / xpi) *  (0.54 + 0.46 * Math.cos(xpi / 1.0)));\n    }\n  },\n  { // Lanczos, win = 2\n    win: 2.0,\n    filter: function (x) {\n      if (x <= -2.0 || x >= 2.0) { return 0.0; }\n      if (x > -1.19209290E-07 && x < 1.19209290E-07) { return 1.0; }\n      var xpi = x * Math.PI;\n      return (Math.sin(xpi) / xpi) * Math.sin(xpi / 2.0) / (xpi / 2.0);\n    }\n  },\n  { // Lanczos, win = 3\n    win: 3.0,\n    filter: function (x) {\n      if (x <= -3.0 || x >= 3.0) { return 0.0; }\n      if (x > -1.19209290E-07 && x < 1.19209290E-07) { return 1.0; }\n      var xpi = x * Math.PI;\n      return (Math.sin(xpi) / xpi) * Math.sin(xpi / 3.0) / (xpi / 3.0);\n    }\n  }\n];\n","// Calculate convolution filters for each destination point,\n// and pack data to Int16Array:\n//\n// [ shift, length, data..., shift2, length2, data..., ... ]\n//\n// - shift - offset in src image\n// - length - filter length (in src points)\n// - data - filter values sequence\n//\n'use strict';\n\n\nvar FILTER_INFO = require('./resize_filter_info');\n\n// Precision of fixed FP values\nvar FIXED_FRAC_BITS = 14;\n\n\nfunction toFixedPoint(num) {\n  return Math.round(num * ((1 << FIXED_FRAC_BITS) - 1));\n}\n\n\nmodule.exports = function resizeFilterGen(quality, srcSize, destSize, scale, offset) {\n\n  var filterFunction = FILTER_INFO[quality].filter;\n\n  var scaleInverted = 1.0 / scale;\n  var scaleClamped  = Math.min(1.0, scale); // For upscale\n\n  // Filter window (averaging interval), scaled to src image\n  var srcWindow = FILTER_INFO[quality].win / scaleClamped;\n\n  var destPixel, srcPixel, srcFirst, srcLast, filterElementSize,\n      floatFilter, fxpFilter, total, pxl, idx, floatVal, filterTotal, filterVal;\n  var leftNotEmpty, rightNotEmpty, filterShift, filterSize;\n\n  var maxFilterElementSize = Math.floor((srcWindow + 1) * 2);\n  var packedFilter    = new Int16Array((maxFilterElementSize + 2) * destSize);\n  var packedFilterPtr = 0;\n\n  var slowCopy = !packedFilter.subarray || !packedFilter.set;\n\n  // For each destination pixel calculate source range and built filter values\n  for (destPixel = 0; destPixel < destSize; destPixel++) {\n\n    // Scaling should be done relative to central pixel point\n    srcPixel = (destPixel + 0.5) * scaleInverted + offset;\n\n    srcFirst = Math.max(0, Math.floor(srcPixel - srcWindow));\n    srcLast  = Math.min(srcSize - 1, Math.ceil(srcPixel + srcWindow));\n\n    filterElementSize = srcLast - srcFirst + 1;\n    floatFilter = new Float32Array(filterElementSize);\n    fxpFilter = new Int16Array(filterElementSize);\n\n    total = 0.0;\n\n    // Fill filter values for calculated range\n    for (pxl = srcFirst, idx = 0; pxl <= srcLast; pxl++, idx++) {\n      floatVal = filterFunction(((pxl + 0.5) - srcPixel) * scaleClamped);\n      total += floatVal;\n      floatFilter[idx] = floatVal;\n    }\n\n    // Normalize filter, convert to fixed point and accumulate conversion error\n    filterTotal = 0;\n\n    for (idx = 0; idx < floatFilter.length; idx++) {\n      filterVal = floatFilter[idx] / total;\n      filterTotal += filterVal;\n      fxpFilter[idx] = toFixedPoint(filterVal);\n    }\n\n    // Compensate normalization error, to minimize brightness drift\n    fxpFilter[destSize >> 1] += toFixedPoint(1.0 - filterTotal);\n\n    //\n    // Now pack filter to useable form\n    //\n    // 1. Trim heading and tailing zero values, and compensate shitf/length\n    // 2. Put all to single array in this format:\n    //\n    //    [ pos shift, data length, value1, value2, value3, ... ]\n    //\n\n    leftNotEmpty = 0;\n    while (leftNotEmpty < fxpFilter.length && fxpFilter[leftNotEmpty] === 0) {\n      leftNotEmpty++;\n    }\n\n    if (leftNotEmpty < fxpFilter.length) {\n      rightNotEmpty = fxpFilter.length - 1;\n      while (rightNotEmpty > 0 && fxpFilter[rightNotEmpty] === 0) {\n        rightNotEmpty--;\n      }\n\n      filterShift = srcFirst + leftNotEmpty;\n      filterSize = rightNotEmpty - leftNotEmpty + 1;\n\n      packedFilter[packedFilterPtr++] = filterShift; // shift\n      packedFilter[packedFilterPtr++] = filterSize; // size\n\n      if (!slowCopy) {\n        packedFilter.set(fxpFilter.subarray(leftNotEmpty, rightNotEmpty + 1), packedFilterPtr);\n        packedFilterPtr += filterSize;\n      } else {\n        // fallback for old IE < 11, without subarray/set methods\n        for (idx = leftNotEmpty; idx <= rightNotEmpty; idx++) {\n          packedFilter[packedFilterPtr++] = fxpFilter[idx];\n        }\n      }\n    } else {\n      // zero data, write header only\n      packedFilter[packedFilterPtr++] = 0; // shift\n      packedFilter[packedFilterPtr++] = 0; // size\n    }\n  }\n  return packedFilter;\n};\n","// Resize convolvers, pure JS implementation\n//\n'use strict';\n\n\n// Precision of fixed FP values\n//var FIXED_FRAC_BITS = 14;\n\n\nfunction clampTo8(i) { return i < 0 ? 0 : (i > 255 ? 255 : i); }\n\n\n// Convolve image in horizontal directions and transpose output. In theory,\n// transpose allow:\n//\n// - use the same convolver for both passes (this fails due different\n//   types of input array and temporary buffer)\n// - making vertical pass by horisonltal lines inprove CPU cache use.\n//\n// But in real life this doesn't work :)\n//\nfunction convolveHorizontally(src, dest, srcW, srcH, destW, filters) {\n\n  var r, g, b, a;\n  var filterPtr, filterShift, filterSize;\n  var srcPtr, srcY, destX, filterVal;\n  var srcOffset = 0, destOffset = 0;\n\n  // For each row\n  for (srcY = 0; srcY < srcH; srcY++) {\n    filterPtr  = 0;\n\n    // Apply precomputed filters to each destination row point\n    for (destX = 0; destX < destW; destX++) {\n      // Get the filter that determines the current output pixel.\n      filterShift = filters[filterPtr++];\n      filterSize  = filters[filterPtr++];\n\n      srcPtr = (srcOffset + (filterShift * 4))|0;\n\n      r = g = b = a = 0;\n\n      // Apply the filter to the row to get the destination pixel r, g, b, a\n      for (; filterSize > 0; filterSize--) {\n        filterVal = filters[filterPtr++];\n\n        // Use reverse order to workaround deopts in old v8 (node v.10)\n        // Big thanks to @mraleph (Vyacheslav Egorov) for the tip.\n        a = (a + filterVal * src[srcPtr + 3])|0;\n        b = (b + filterVal * src[srcPtr + 2])|0;\n        g = (g + filterVal * src[srcPtr + 1])|0;\n        r = (r + filterVal * src[srcPtr])|0;\n        srcPtr = (srcPtr + 4)|0;\n      }\n\n      // Bring this value back in range. All of the filter scaling factors\n      // are in fixed point with FIXED_FRAC_BITS bits of fractional part.\n      //\n      // (!) Add 1/2 of value before clamping to get proper rounding. In other\n      // case brightness loss will be noticeable if you resize image with white\n      // border and place it on white background.\n      //\n      dest[destOffset + 3] = clampTo8((a + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset + 2] = clampTo8((b + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset + 1] = clampTo8((g + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset]     = clampTo8((r + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      destOffset = (destOffset + srcH * 4)|0;\n    }\n\n    destOffset = ((srcY + 1) * 4)|0;\n    srcOffset  = ((srcY + 1) * srcW * 4)|0;\n  }\n}\n\n// Technically, convolvers are the same. But input array and temporary\n// buffer can be of different type (especially, in old browsers). So,\n// keep code in separate functions to avoid deoptimizations & speed loss.\n\nfunction convolveVertically(src, dest, srcW, srcH, destW, filters) {\n\n  var r, g, b, a;\n  var filterPtr, filterShift, filterSize;\n  var srcPtr, srcY, destX, filterVal;\n  var srcOffset = 0, destOffset = 0;\n\n  // For each row\n  for (srcY = 0; srcY < srcH; srcY++) {\n    filterPtr  = 0;\n\n    // Apply precomputed filters to each destination row point\n    for (destX = 0; destX < destW; destX++) {\n      // Get the filter that determines the current output pixel.\n      filterShift = filters[filterPtr++];\n      filterSize  = filters[filterPtr++];\n\n      srcPtr = (srcOffset + (filterShift * 4))|0;\n\n      r = g = b = a = 0;\n\n      // Apply the filter to the row to get the destination pixel r, g, b, a\n      for (; filterSize > 0; filterSize--) {\n        filterVal = filters[filterPtr++];\n\n        // Use reverse order to workaround deopts in old v8 (node v.10)\n        // Big thanks to @mraleph (Vyacheslav Egorov) for the tip.\n        a = (a + filterVal * src[srcPtr + 3])|0;\n        b = (b + filterVal * src[srcPtr + 2])|0;\n        g = (g + filterVal * src[srcPtr + 1])|0;\n        r = (r + filterVal * src[srcPtr])|0;\n        srcPtr = (srcPtr + 4)|0;\n      }\n\n      // Bring this value back in range. All of the filter scaling factors\n      // are in fixed point with FIXED_FRAC_BITS bits of fractional part.\n      //\n      // (!) Add 1/2 of value before clamping to get proper rounding. In other\n      // case brightness loss will be noticeable if you resize image with white\n      // border and place it on white background.\n      //\n      dest[destOffset + 3] = clampTo8((a + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset + 2] = clampTo8((b + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset + 1] = clampTo8((g + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      dest[destOffset]     = clampTo8((r + (1 << 13)) >> 14/*FIXED_FRAC_BITS*/);\n      destOffset = (destOffset + srcH * 4)|0;\n    }\n\n    destOffset = ((srcY + 1) * 4)|0;\n    srcOffset  = ((srcY + 1) * srcW * 4)|0;\n  }\n}\n\n\nmodule.exports = {\n  convolveHorizontally,\n  convolveVertically\n};\n","'use strict';\n\n\nconst createFilters        = require('./resize_filter_gen');\nconst convolveHorizontally = require('./convolve').convolveHorizontally;\nconst convolveVertically   = require('./convolve').convolveVertically;\n\n\nfunction resetAlpha(dst, width, height) {\n  let ptr = 3, len = (width * height * 4)|0;\n  while (ptr < len) { dst[ptr] = 0xFF; ptr = (ptr + 4)|0; }\n}\n\n\nmodule.exports = function resize(options) {\n  const src   = options.src;\n  const srcW  = options.width;\n  const srcH  = options.height;\n  const destW = options.toWidth;\n  const destH = options.toHeight;\n  const scaleX = options.scaleX || options.toWidth / options.width;\n  const scaleY = options.scaleY || options.toHeight / options.height;\n  const offsetX = options.offsetX || 0;\n  const offsetY = options.offsetY || 0;\n  const dest  = options.dest || new Uint8Array(destW * destH * 4);\n  const quality = typeof options.quality === 'undefined' ? 3 : options.quality;\n  const alpha = options.alpha || false;\n\n  const filtersX = createFilters(quality, srcW, destW, scaleX, offsetX),\n        filtersY = createFilters(quality, srcH, destH, scaleY, offsetY);\n\n  const tmp  = new Uint8Array(destW * srcH * 4);\n\n  // To use single function we need src & tmp of the same type.\n  // But src can be CanvasPixelArray, and tmp - Uint8Array. So, keep\n  // vertical and horizontal passes separately to avoid deoptimization.\n\n  convolveHorizontally(src, tmp, srcW, srcH, destW, filtersX);\n  convolveVertically(tmp, dest, srcH, destW, destH, filtersY);\n\n  // That's faster than doing checks in convolver.\n  // !!! Note, canvas data is not premultipled. We don't need other\n  // alpha corrections.\n\n  if (!alpha) resetAlpha(dest, destW, destH);\n\n  return dest;\n};\n","'use strict';\n\n\nconst createFilters = require('./resize_filter_gen');\n\n\nfunction resetAlpha(dst, width, height) {\n  let ptr = 3, len = (width * height * 4)|0;\n  while (ptr < len) { dst[ptr] = 0xFF; ptr = (ptr + 4)|0; }\n}\n\n\nfunction asUint8Array(src) {\n  return new Uint8Array(src.buffer, 0, src.byteLength);\n}\n\n\nlet IS_LE = true;\n// should not crash everything on module load in old browsers\ntry {\n  IS_LE = ((new Uint32Array((new Uint8Array([ 1, 0, 0, 0 ])).buffer))[0] === 1);\n} catch (__) {}\n\n\nfunction copyInt16asLE(src, target, target_offset) {\n  if (IS_LE) {\n    target.set(asUint8Array(src), target_offset);\n    return;\n  }\n\n  for (let ptr = target_offset, i = 0; i < src.length; i++) {\n    let data = src[i];\n    target[ptr++] = data & 0xFF;\n    target[ptr++] = (data >> 8) & 0xFF;\n  }\n}\n\nmodule.exports = function resize_wasm(options) {\n  const src     = options.src;\n  const srcW    = options.width;\n  const srcH    = options.height;\n  const destW   = options.toWidth;\n  const destH   = options.toHeight;\n  const scaleX  = options.scaleX || options.toWidth / options.width;\n  const scaleY  = options.scaleY || options.toHeight / options.height;\n  const offsetX = options.offsetX || 0.0;\n  const offsetY = options.offsetY || 0.0;\n  const dest    = options.dest || new Uint8Array(destW * destH * 4);\n  const quality = typeof options.quality === 'undefined' ? 3 : options.quality;\n  const alpha   = options.alpha || false;\n\n  const filtersX = createFilters(quality, srcW, destW, scaleX, offsetX),\n        filtersY = createFilters(quality, srcH, destH, scaleY, offsetY);\n\n  // destination is 0 too.\n  const src_offset      = 0;\n  // buffer between convolve passes\n  const tmp_offset      = this.__align(src_offset + Math.max(src.byteLength, dest.byteLength));\n  const filtersX_offset = this.__align(tmp_offset + srcH * destW * 4);\n  const filtersY_offset = this.__align(filtersX_offset + filtersX.byteLength);\n  const alloc_bytes     = filtersY_offset + filtersY.byteLength;\n\n  const instance = this.__instance('resize', alloc_bytes);\n\n  //\n  // Fill memory block with data to process\n  //\n\n  const mem   = new Uint8Array(this.__memory.buffer);\n  const mem32 = new Uint32Array(this.__memory.buffer);\n\n  // 32-bit copy is much faster in chrome\n  const src32 = new Uint32Array(src.buffer);\n  mem32.set(src32);\n\n  // We should guarantee LE bytes order. Filters are not big, so\n  // speed difference is not significant vs direct .set()\n  copyInt16asLE(filtersX, mem, filtersX_offset);\n  copyInt16asLE(filtersY, mem, filtersY_offset);\n\n  //\n  // Now call webassembly method\n  // emsdk does method names with '_'\n  const fn = instance.exports.convolveHV || instance.exports._convolveHV;\n\n  fn(filtersX_offset, filtersY_offset, tmp_offset, srcW, srcH, destW, destH);\n\n  //\n  // Copy data back to typed array\n  //\n\n  // 32-bit copy is much faster in chrome\n  const dest32 = new Uint32Array(dest.buffer);\n  dest32.set(new Uint32Array(this.__memory.buffer, 0, destH * destW));\n\n  // That's faster than doing checks in convolver.\n  // !!! Note, canvas data is not premultipled. We don't need other\n  // alpha corrections.\n\n  if (!alpha) resetAlpha(dest, destW, destH);\n\n  return dest;\n};\n","// This is autogenerated file from math.wasm, don't edit.\n//\n'use strict';\n\n/* eslint-disable max-len */\nmodule.exports = 'AGFzbQEAAAABFAJgBn9/f39/fwBgB39/f39/f38AAg8BA2VudgZtZW1vcnkCAAEDAwIAAQQEAXAAAAcZAghjb252b2x2ZQAACmNvbnZvbHZlSFYAAQkBAArmAwLBAwEQfwJAIANFDQAgBEUNACAFQQRqIRVBACEMQQAhDQNAIA0hDkEAIRFBACEHA0AgB0ECaiESAn8gBSAHQQF0IgdqIgZBAmouAQAiEwRAQQAhCEEAIBNrIRQgFSAHaiEPIAAgDCAGLgEAakECdGohEEEAIQlBACEKQQAhCwNAIBAoAgAiB0EYdiAPLgEAIgZsIAtqIQsgB0H/AXEgBmwgCGohCCAHQRB2Qf8BcSAGbCAKaiEKIAdBCHZB/wFxIAZsIAlqIQkgD0ECaiEPIBBBBGohECAUQQFqIhQNAAsgEiATagwBC0EAIQtBACEKQQAhCUEAIQggEgshByABIA5BAnRqIApBgMAAakEOdSIGQf8BIAZB/wFIG0EQdEGAgPwHcUEAIAZBAEobIAtBgMAAakEOdSIGQf8BIAZB/wFIG0EYdEEAIAZBAEobciAJQYDAAGpBDnUiBkH/ASAGQf8BSBtBCHRBgP4DcUEAIAZBAEobciAIQYDAAGpBDnUiBkH/ASAGQf8BSBtB/wFxQQAgBkEAShtyNgIAIA4gA2ohDiARQQFqIhEgBEcNAAsgDCACaiEMIA1BAWoiDSADRw0ACwsLIQACQEEAIAIgAyAEIAUgABAAIAJBACAEIAUgBiABEAALCw==';\n","'use strict';\n\nmodule.exports = {\n  name:     'resize',\n  fn:       require('./resize'),\n  wasm_fn:  require('./resize_wasm'),\n  wasm_src: require('./convolve_wasm_base64')\n};\n","// Collection of math functions\n//\n// 1. Combine components together\n// 2. Has async init to load wasm modules\n//\n'use strict';\n\n\nconst inherits  = require('inherits');\nconst Multimath = require('multimath');\n\nconst mm_unsharp_mask = require('multimath/lib/unsharp_mask');\nconst mm_resize       = require('./mm_resize');\n\n\nfunction MathLib(requested_features) {\n  const __requested_features = requested_features || [];\n\n  let features = {\n    js:   __requested_features.indexOf('js') >= 0,\n    wasm: __requested_features.indexOf('wasm') >= 0\n  };\n\n  Multimath.call(this, features);\n\n  this.features = {\n    js:   features.js,\n    wasm: features.wasm && this.has_wasm()\n  };\n\n  this.use(mm_unsharp_mask);\n  this.use(mm_resize);\n}\n\n\ninherits(MathLib, Multimath);\n\n\nMathLib.prototype.resizeAndUnsharp = function resizeAndUnsharp(options, cache) {\n  let result = this.resize(options, cache);\n\n  if (options.unsharpAmount) {\n    this.unsharp_mask(\n      result,\n      options.toWidth,\n      options.toHeight,\n      options.unsharpAmount,\n      options.unsharpRadius,\n      options.unsharpThreshold\n    );\n  }\n\n  return result;\n};\n\n\nmodule.exports = MathLib;\n","'use strict';\n\n\nconst GC_INTERVAL = 100;\n\n\nfunction Pool(create, idle) {\n  this.create = create;\n\n  this.available = [];\n  this.acquired = {};\n  this.lastId = 1;\n\n  this.timeoutId = 0;\n  this.idle = idle || 2000;\n}\n\n\nPool.prototype.acquire = function () {\n  let resource;\n\n  if (this.available.length !== 0) {\n    resource = this.available.pop();\n  } else {\n    resource = this.create();\n    resource.id = this.lastId++;\n    resource.release = () => this.release(resource);\n  }\n  this.acquired[resource.id] = resource;\n  return resource;\n};\n\n\nPool.prototype.release = function (resource) {\n  delete this.acquired[resource.id];\n\n  resource.lastUsed = Date.now();\n  this.available.push(resource);\n\n  if (this.timeoutId === 0) {\n    this.timeoutId = setTimeout(() => this.gc(), GC_INTERVAL);\n  }\n};\n\n\nPool.prototype.gc = function () {\n  const now = Date.now();\n\n  this.available = this.available.filter(resource => {\n    if (now - resource.lastUsed > this.idle) {\n      resource.destroy();\n      return false;\n    }\n    return true;\n  });\n\n  if (this.available.length !== 0) {\n    this.timeoutId = setTimeout(() => this.gc(), GC_INTERVAL);\n  } else {\n    this.timeoutId = 0;\n  }\n};\n\n\nmodule.exports = Pool;\n","'use strict';\n\n\nfunction objClass(obj) { return Object.prototype.toString.call(obj); }\n\n\nmodule.exports.isCanvas = function isCanvas(element) {\n  //return (element.nodeName && element.nodeName.toLowerCase() === 'canvas') ||\n  let cname = objClass(element);\n\n  return cname === '[object HTMLCanvasElement]'/* browser */ ||\n         cname === '[object Canvas]'/* node-canvas */;\n};\n\n\nmodule.exports.isImage = function isImage(element) {\n  //return element.nodeName && element.nodeName.toLowerCase() === 'img';\n  return objClass(element) === '[object HTMLImageElement]';\n};\n\n\nmodule.exports.limiter = function limiter(concurrency) {\n  let active = 0,\n      queue  = [];\n\n  function roll() {\n    if (active < concurrency && queue.length) {\n      active++;\n      queue.shift()();\n    }\n  }\n\n  return function limit(fn) {\n    return new Promise((resolve, reject) => {\n      queue.push(() => {\n        fn().then(\n          result => {\n            resolve(result);\n            active--;\n            roll();\n          },\n          err => {\n            reject(err);\n            active--;\n            roll();\n          }\n        );\n      });\n\n      roll();\n    });\n  };\n};\n\n\nmodule.exports.cib_quality_name = function cib_quality_name(num) {\n  switch (num) {\n    case 0: return 'pixelated';\n    case 1: return 'low';\n    case 2: return 'medium';\n  }\n  return 'high';\n};\n\n\nmodule.exports.cib_support = function cib_support() {\n  return Promise.resolve().then(() => {\n    if (typeof createImageBitmap === 'undefined' ||\n        typeof document === 'undefined') {\n      return false;\n    }\n\n    let c = document.createElement('canvas');\n    c.width = 100;\n    c.height = 100;\n\n    return createImageBitmap(c, 0, 0, 100, 100, {\n      resizeWidth: 10,\n      resizeHeight: 10,\n      resizeQuality: 'high'\n    })\n    .then(bitmap => {\n      let status = (bitmap.width === 10);\n\n      // Branch below is filtered on upper level. We do not call resize\n      // detection for basic ImageBitmap.\n      //\n      // https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap\n      // old Crome 51 has ImageBitmap without .close(). Then this code\n      // will throw and return 'false' as expected.\n      //\n      bitmap.close();\n      c = null;\n      return status;\n    });\n  })\n  .catch(() => false);\n};\n","// Web Worker wrapper for image resize function\n\n'use strict';\n\nmodule.exports = function () {\n  const MathLib = require('./mathlib');\n\n  let mathLib;\n\n  /* eslint-disable no-undef */\n  onmessage = function (ev) {\n    let opts = ev.data.opts;\n\n    if (!mathLib) mathLib = new MathLib(ev.data.features);\n\n    // Use multimath's sync auto-init. Avoid Promise use in old browsers,\n    // because polyfills are not propagated to webworker.\n    let result = mathLib.resizeAndUnsharp(opts);\n\n    postMessage({ result }, [ result.buffer ]);\n  };\n};\n","// Add intermediate resizing steps when scaling down by a very large factor.\n//\n// For example, when resizing 10000x10000 down to 10x10, it'll resize it to\n// 300x300 first.\n//\n// It's needed because tiler has issues when the entire tile is scaled down\n// to a few pixels (1024px source tile with border size 3 should result in\n// at least 3+3+2 = 8px target tile, so max scale factor is 128 here).\n//\n// Also, adding intermediate steps can speed up processing if we use lower\n// quality algorithms for first stages.\n//\n\n'use strict';\n\n\n// min size = 0 results in infinite loop,\n// min size = 1 can consume large amount of memory\nconst MIN_INNER_TILE_SIZE = 2;\n\n\nmodule.exports = function createStages(fromWidth, fromHeight, toWidth, toHeight, srcTileSize, destTileBorder) {\n  let scaleX = toWidth / fromWidth;\n  let scaleY = toHeight / fromHeight;\n\n  // derived from createRegions equation:\n  // innerTileWidth = pixelFloor(srcTileSize * scaleX) - 2 * destTileBorder;\n  let minScale = (2 * destTileBorder + MIN_INNER_TILE_SIZE + 1) / srcTileSize;\n\n  // refuse to scale image multiple times by less than twice each time,\n  // it could only happen because of invalid options\n  if (minScale > 0.5) return [ [ toWidth, toHeight ] ];\n\n  let stageCount = Math.ceil(Math.log(Math.min(scaleX, scaleY)) / Math.log(minScale));\n\n  // no additional resizes are necessary,\n  // stageCount can be zero or be negative when enlarging the image\n  if (stageCount <= 1) return [ [ toWidth, toHeight ] ];\n\n  let result = [];\n\n  for (let i = 0; i < stageCount; i++) {\n    let width = Math.round(\n      Math.pow(\n        Math.pow(fromWidth, stageCount - i - 1) * Math.pow(toWidth, i + 1),\n        1 / stageCount\n      )\n    );\n\n    let height = Math.round(\n      Math.pow(\n        Math.pow(fromHeight, stageCount - i - 1) * Math.pow(toHeight, i + 1),\n        1 / stageCount\n      )\n    );\n\n    result.push([ width, height ]);\n  }\n\n  return result;\n};\n","// Split original image into multiple 1024x1024 chunks to reduce memory usage\n// (images have to be unpacked into typed arrays for resizing) and allow\n// parallel processing of multiple tiles at a time.\n//\n\n'use strict';\n\n/*\n * pixelFloor and pixelCeil are modified versions of Math.floor and Math.ceil\n * functions which take into account floating point arithmetic errors.\n * Those errors can cause undesired increments/decrements of sizes and offsets:\n * Math.ceil(36 / (36 / 500)) = 501\n * pixelCeil(36 / (36 / 500)) = 500\n */\n\nvar PIXEL_EPSILON = 1e-5;\n\nfunction pixelFloor(x) {\n  var nearest = Math.round(x);\n\n  if (Math.abs(x - nearest) < PIXEL_EPSILON) { return nearest; }\n  return Math.floor(x);\n}\n\nfunction pixelCeil(x) {\n  var nearest = Math.round(x);\n\n  if (Math.abs(x - nearest) < PIXEL_EPSILON) { return nearest; }\n  return Math.ceil(x);\n}\n\n\nmodule.exports = function createRegions(options) {\n  var scaleX = options.toWidth / options.width;\n  var scaleY = options.toHeight / options.height;\n\n  var innerTileWidth = pixelFloor(options.srcTileSize * scaleX) - 2 * options.destTileBorder;\n  var innerTileHeight = pixelFloor(options.srcTileSize * scaleY) - 2 * options.destTileBorder;\n\n  // prevent infinite loop, this should never happen\n  if (innerTileWidth < 1 || innerTileHeight < 1) {\n    throw new Error('Internal error in pica: target tile width/height is too small.');\n  }\n\n  var x, y;\n  var innerX, innerY, toTileWidth, toTileHeight;\n  var tiles = [];\n  var tile;\n\n  // we go top-to-down instead of left-to-right to make image displayed from top to\n  // doesn in the browser\n  for (innerY = 0; innerY < options.toHeight; innerY += innerTileHeight) {\n    for (innerX = 0; innerX < options.toWidth; innerX += innerTileWidth) {\n      x = innerX - options.destTileBorder;\n      if (x < 0) { x = 0; }\n      toTileWidth = innerX + innerTileWidth + options.destTileBorder - x;\n      if (x + toTileWidth >= options.toWidth) {\n        toTileWidth = options.toWidth - x;\n      }\n\n      y = innerY - options.destTileBorder;\n      if (y < 0) { y = 0; }\n      toTileHeight = innerY + innerTileHeight + options.destTileBorder - y;\n      if (y + toTileHeight >= options.toHeight) {\n        toTileHeight = options.toHeight - y;\n      }\n\n      tile = {\n        toX: x,\n        toY: y,\n        toWidth: toTileWidth,\n        toHeight: toTileHeight,\n\n        toInnerX: innerX,\n        toInnerY: innerY,\n        toInnerWidth: innerTileWidth,\n        toInnerHeight: innerTileHeight,\n\n        offsetX: x / scaleX - pixelFloor(x / scaleX),\n        offsetY: y / scaleY - pixelFloor(y / scaleY),\n        scaleX: scaleX,\n        scaleY: scaleY,\n\n        x: pixelFloor(x / scaleX),\n        y: pixelFloor(y / scaleY),\n        width: pixelCeil(toTileWidth / scaleX),\n        height: pixelCeil(toTileHeight / scaleY)\n      };\n\n      tiles.push(tile);\n    }\n  }\n\n  return tiles;\n};\n","'use strict';\n\n\nconst assign        = require('object-assign');\nconst webworkify    = require('webworkify');\n\n\nconst MathLib       = require('./lib/mathlib');\nconst Pool          = require('./lib/pool');\nconst utils         = require('./lib/utils');\nconst worker        = require('./lib/worker');\nconst createStages  = require('./lib/stepper');\nconst createRegions = require('./lib/tiler');\n\n\n// Deduplicate pools & limiters with the same configs\n// when user creates multiple pica instances.\nconst singletones = {};\n\n\nlet NEED_SAFARI_FIX = false;\ntry {\n  if (typeof navigator !== 'undefined' && navigator.userAgent) {\n    NEED_SAFARI_FIX = navigator.userAgent.indexOf('Safari') >= 0;\n  }\n} catch (e) {}\n\n\nlet concurrency = 1;\nif (typeof navigator !== 'undefined') {\n  concurrency = Math.min(navigator.hardwareConcurrency || 1, 4);\n}\n\n\nconst DEFAULT_PICA_OPTS = {\n  tile: 1024,\n  concurrency,\n  features: [ 'js', 'wasm', 'ww' ],\n  idle: 2000\n};\n\n\nconst DEFAULT_RESIZE_OPTS = {\n  quality:          3,\n  alpha:            false,\n  unsharpAmount:    0,\n  unsharpRadius:    0.0,\n  unsharpThreshold: 0\n};\n\nlet CAN_NEW_IMAGE_DATA;\nlet CAN_CREATE_IMAGE_BITMAP;\n\n\nfunction workerFabric() {\n  return {\n    value: webworkify(worker),\n    destroy: function () {\n      this.value.terminate();\n\n      if (typeof window !== 'undefined') {\n        let url = window.URL || window.webkitURL || window.mozURL || window.msURL;\n        if (url && url.revokeObjectURL && this.value.objectURL) {\n          url.revokeObjectURL(this.value.objectURL);\n        }\n      }\n    }\n  };\n}\n\n\n////////////////////////////////////////////////////////////////////////////////\n// API methods\n\nfunction Pica(options) {\n  if (!(this instanceof Pica)) return new Pica(options);\n\n  this.options = assign({}, DEFAULT_PICA_OPTS, options || {});\n\n  let limiter_key = `lk_${this.options.concurrency}`;\n\n  // Share limiters to avoid multiple parallel workers when user creates\n  // multiple pica instances.\n  this.__limit = singletones[limiter_key] || utils.limiter(this.options.concurrency);\n\n  if (!singletones[limiter_key]) singletones[limiter_key] = this.__limit;\n\n  // List of supported features, according to options & browser/node.js\n  this.features = {\n    js:   false, // pure JS implementation, can be disabled for testing\n    wasm: false, // webassembly implementation for heavy functions\n    cib:  false, // resize via createImageBitmap (only FF at this moment)\n    ww:   false  // webworkers\n  };\n\n  this.__workersPool = null;\n\n  // Store requested features for webworkers\n  this.__requested_features = [];\n\n  this.__mathlib = null;\n}\n\n\nPica.prototype.init = function () {\n  if (this.__initPromise) return this.__initPromise;\n\n  // Test if we can create ImageData without canvas and memory copy\n  if (CAN_NEW_IMAGE_DATA !== false && CAN_NEW_IMAGE_DATA !== true) {\n    CAN_NEW_IMAGE_DATA = false;\n    if (typeof ImageData !== 'undefined' && typeof Uint8ClampedArray !== 'undefined') {\n      try {\n        /* eslint-disable no-new */\n        new ImageData(new Uint8ClampedArray(400), 10, 10);\n        CAN_NEW_IMAGE_DATA = true;\n      } catch (__) {}\n    }\n  }\n\n  // ImageBitmap can be effective in 2 places:\n  //\n  // 1. Threaded jpeg unpack (basic)\n  // 2. Built-in resize (blocked due problem in chrome, see issue #89)\n  //\n  // For basic use we also need ImageBitmap wo support .close() method,\n  // see https://developer.mozilla.org/ru/docs/Web/API/ImageBitmap\n\n  if (CAN_CREATE_IMAGE_BITMAP !== false && CAN_CREATE_IMAGE_BITMAP !== true) {\n    CAN_CREATE_IMAGE_BITMAP = false;\n    if (typeof ImageBitmap !== 'undefined') {\n      if (ImageBitmap.prototype && ImageBitmap.prototype.close) {\n        CAN_CREATE_IMAGE_BITMAP = true;\n      } else {\n        this.debug('ImageBitmap does not support .close(), disabled');\n      }\n    }\n  }\n\n\n  let features = this.options.features.slice();\n\n  if (features.indexOf('all') >= 0) {\n    features = [ 'cib', 'wasm', 'js', 'ww' ];\n  }\n\n  this.__requested_features = features;\n\n  this.__mathlib = new MathLib(features);\n\n  // Check WebWorker support if requested\n  if (features.indexOf('ww') >= 0) {\n    if ((typeof window !== 'undefined') && ('Worker' in window)) {\n      // IE <= 11 don't allow to create webworkers from string. We should check it.\n      // https://connect.microsoft.com/IE/feedback/details/801810/web-workers-from-blob-urls-in-ie-10-and-11\n      try {\n        let wkr = require('webworkify')(function () {});\n        wkr.terminate();\n        this.features.ww   = true;\n\n        // pool uniqueness depends on pool config + webworker config\n        let wpool_key = `wp_${JSON.stringify(this.options)}`;\n\n        if (singletones[wpool_key]) {\n          this.__workersPool = singletones[wpool_key];\n        } else {\n          this.__workersPool = new Pool(workerFabric, this.options.idle);\n          singletones[wpool_key] = this.__workersPool;\n        }\n      } catch (__) {}\n    }\n  }\n\n  let initMath = this.__mathlib.init().then(mathlib => {\n    // Copy detected features\n    assign(this.features, mathlib.features);\n  });\n\n  let checkCibResize;\n\n  if (!CAN_CREATE_IMAGE_BITMAP) {\n    checkCibResize = Promise.resolve(false);\n  } else {\n    checkCibResize = utils.cib_support().then(status => {\n      if (this.features.cib && features.indexOf('cib') < 0) {\n        this.debug('createImageBitmap() resize supported, but disabled by config');\n        return;\n      }\n\n      if (features.indexOf('cib') >= 0) this.features.cib = status;\n    });\n  }\n\n  // Init math lib. That's async because can load some\n  this.__initPromise = Promise.all([ initMath, checkCibResize ]).then(() => this);\n\n  return this.__initPromise;\n};\n\n\nPica.prototype.resize = function (from, to, options) {\n  this.debug('Start resize...');\n\n\n  let opts = assign({}, DEFAULT_RESIZE_OPTS);\n\n  if (!isNaN(options)) {\n    opts = assign(opts, { quality: options });\n  } else if (options) {\n    opts = assign(opts, options);\n  }\n\n  opts.toWidth  = to.width;\n  opts.toHeight = to.height;\n  opts.width    = from.naturalWidth || from.width;\n  opts.height   = from.naturalHeight || from.height;\n\n  // Prevent stepper from infinite loop\n  if (to.width === 0 || to.height === 0) {\n    return Promise.reject(new Error(`Invalid output size: ${to.width}x${to.height}`));\n  }\n\n  if (opts.unsharpRadius > 2) opts.unsharpRadius = 2;\n\n  let canceled    = false;\n  let cancelToken = null;\n\n  if (opts.cancelToken) {\n    // Wrap cancelToken to avoid successive resolve & set flag\n    cancelToken = opts.cancelToken.then(\n      data => { canceled = true; throw data; },\n      err  => { canceled = true; throw err; }\n    );\n  }\n\n  let DEST_TILE_BORDER = 3; // Max possible filter window size\n  let destTileBorder = Math.ceil(Math.max(DEST_TILE_BORDER, 2.5 * opts.unsharpRadius|0));\n\n  return this.init().then(() => {\n    if (canceled) return cancelToken;\n\n    // if createImageBitmap supports resize, just do it and return\n    if (this.features.cib) {\n      let toCtx = to.getContext('2d', { alpha: Boolean(opts.alpha) });\n\n      this.debug('Resize via createImageBitmap()');\n\n      return createImageBitmap(from, {\n        resizeWidth:   opts.toWidth,\n        resizeHeight:  opts.toHeight,\n        resizeQuality: utils.cib_quality_name(opts.quality)\n      })\n      .then(imageBitmap => {\n        if (canceled) return cancelToken;\n\n        // if no unsharp - draw directly to output canvas\n        if (!opts.unsharpAmount) {\n          toCtx.drawImage(imageBitmap, 0, 0);\n          imageBitmap.close();\n          toCtx = null;\n\n          this.debug('Finished!');\n\n          return to;\n        }\n\n        this.debug('Unsharp result');\n\n        let tmpCanvas = document.createElement('canvas');\n\n        tmpCanvas.width  = opts.toWidth;\n        tmpCanvas.height = opts.toHeight;\n\n        let tmpCtx = tmpCanvas.getContext('2d', { alpha: Boolean(opts.alpha) });\n\n        tmpCtx.drawImage(imageBitmap, 0, 0);\n        imageBitmap.close();\n\n        let iData = tmpCtx.getImageData(0, 0, opts.toWidth, opts.toHeight);\n\n        this.__mathlib.unsharp_mask(\n          iData.data,\n          opts.toWidth,\n          opts.toHeight,\n          opts.unsharpAmount,\n          opts.unsharpRadius,\n          opts.unsharpThreshold\n        );\n\n        toCtx.putImageData(iData, 0, 0);\n        iData = tmpCtx = tmpCanvas = toCtx = null;\n\n        this.debug('Finished!');\n\n        return to;\n      });\n    }\n\n    //\n    // No easy way, let's resize manually via arrays\n    //\n\n    // Share cache between calls:\n    //\n    // - wasm instance\n    // - wasm memory object\n    //\n    let cache = {};\n\n    // Call resizer in webworker or locally, depending on config\n    const invokeResize = opts => {\n      return Promise.resolve().then(() => {\n        if (!this.features.ww) return this.__mathlib.resizeAndUnsharp(opts, cache);\n\n        return new Promise((resolve, reject) => {\n          let w = this.__workersPool.acquire();\n\n          if (cancelToken) cancelToken.catch(err => reject(err));\n\n          w.value.onmessage = ev => {\n            w.release();\n\n            if (ev.data.err) reject(ev.data.err);\n            else resolve(ev.data.result);\n          };\n\n          w.value.postMessage({\n            opts,\n            features: this.__requested_features,\n            preload: {\n              wasm_nodule: this.__mathlib.__\n            }\n          }, [ opts.src.buffer ]);\n        });\n      });\n    };\n\n\n    const tileAndResize = (from, to, opts) => {\n      let srcCtx;\n      let srcImageBitmap;\n      let toCtx;\n\n      const processTile = (tile => this.__limit(() => {\n        if (canceled) return cancelToken;\n\n        let srcImageData;\n\n        // Extract tile RGBA buffer, depending on input type\n        if (utils.isCanvas(from)) {\n          this.debug('Get tile pixel data');\n\n          // If input is Canvas - extract region data directly\n          srcImageData = srcCtx.getImageData(tile.x, tile.y, tile.width, tile.height);\n        } else {\n          // If input is Image or decoded to ImageBitmap,\n          // draw region to temporary canvas and extract data from it\n          //\n          // Note! Attempt to reuse this canvas causes significant slowdown in chrome\n          //\n          this.debug('Draw tile imageBitmap/image to temporary canvas');\n\n          let tmpCanvas = document.createElement('canvas');\n          tmpCanvas.width  = tile.width;\n          tmpCanvas.height = tile.height;\n\n          let tmpCtx = tmpCanvas.getContext('2d', { alpha: Boolean(opts.alpha) });\n          tmpCtx.globalCompositeOperation = 'copy';\n          tmpCtx.drawImage(srcImageBitmap || from,\n            tile.x, tile.y, tile.width, tile.height,\n            0, 0, tile.width, tile.height);\n\n          this.debug('Get tile pixel data');\n\n          srcImageData = tmpCtx.getImageData(0, 0, tile.width, tile.height);\n          tmpCtx = tmpCanvas = null;\n        }\n\n        let o = {\n          src:              srcImageData.data,\n          width:            tile.width,\n          height:           tile.height,\n          toWidth:          tile.toWidth,\n          toHeight:         tile.toHeight,\n          scaleX:           tile.scaleX,\n          scaleY:           tile.scaleY,\n          offsetX:          tile.offsetX,\n          offsetY:          tile.offsetY,\n          quality:          opts.quality,\n          alpha:            opts.alpha,\n          unsharpAmount:    opts.unsharpAmount,\n          unsharpRadius:    opts.unsharpRadius,\n          unsharpThreshold: opts.unsharpThreshold\n        };\n\n        this.debug('Invoke resize math');\n\n        return Promise.resolve()\n          .then(() => invokeResize(o))\n          .then(result => {\n            if (canceled) return cancelToken;\n\n            srcImageData = null;\n\n            let toImageData;\n\n            this.debug('Convert raw rgba tile result to ImageData');\n\n            if (CAN_NEW_IMAGE_DATA) {\n              // this branch is for modern browsers\n              // If `new ImageData()` & Uint8ClampedArray suported\n              toImageData = new ImageData(new Uint8ClampedArray(result), tile.toWidth, tile.toHeight);\n            } else {\n              // fallback for `node-canvas` and old browsers\n              // (IE11 has ImageData but does not support `new ImageData()`)\n              toImageData = toCtx.createImageData(tile.toWidth, tile.toHeight);\n\n              if (toImageData.data.set) {\n                toImageData.data.set(result);\n              } else {\n                // IE9 don't have `.set()`\n                for (let i = toImageData.data.length - 1; i >= 0; i--) {\n                  toImageData.data[i] = result[i];\n                }\n              }\n            }\n\n            this.debug('Draw tile');\n\n            if (NEED_SAFARI_FIX) {\n              // Safari draws thin white stripes between tiles without this fix\n              toCtx.putImageData(toImageData, tile.toX, tile.toY,\n                tile.toInnerX - tile.toX, tile.toInnerY - tile.toY,\n                tile.toInnerWidth + 1e-5, tile.toInnerHeight + 1e-5);\n            } else {\n              toCtx.putImageData(toImageData, tile.toX, tile.toY,\n                tile.toInnerX - tile.toX, tile.toInnerY - tile.toY,\n                tile.toInnerWidth, tile.toInnerHeight);\n            }\n\n            return null;\n          });\n      }));\n\n\n      // Need to normalize data source first. It can be canvas or image.\n      // If image - try to decode in background if possible\n      return Promise.resolve().then(() => {\n        toCtx = to.getContext('2d', { alpha: Boolean(opts.alpha) });\n\n        if (utils.isCanvas(from)) {\n          srcCtx = from.getContext('2d', { alpha: Boolean(opts.alpha) });\n          return null;\n        }\n\n        if (utils.isImage(from)) {\n          // try do decode image in background for faster next operations\n          if (!CAN_CREATE_IMAGE_BITMAP) return null;\n\n          this.debug('Decode image via createImageBitmap');\n\n          return createImageBitmap(from)\n            .then(imageBitmap => {\n              srcImageBitmap = imageBitmap;\n            });\n        }\n\n        throw new Error('\".from\" should be image or canvas');\n      })\n      .then(() => {\n        if (canceled) return cancelToken;\n\n        this.debug('Calculate tiles');\n\n        //\n        // Here we are with \"normalized\" source,\n        // follow to tiling\n        //\n\n        let regions = createRegions({\n          width:        opts.width,\n          height:       opts.height,\n          srcTileSize:  this.options.tile,\n          toWidth:      opts.toWidth,\n          toHeight:     opts.toHeight,\n          destTileBorder\n        });\n\n        let jobs = regions.map(tile => processTile(tile));\n\n        function cleanup() {\n          if (srcImageBitmap) {\n            srcImageBitmap.close();\n            srcImageBitmap = null;\n          }\n        }\n\n        this.debug('Process tiles');\n\n        return Promise.all(jobs).then(\n          () => {\n            this.debug('Finished!');\n            cleanup(); return to;\n          },\n          err => { cleanup(); throw err; }\n        );\n      });\n    };\n\n\n    const processStages = (stages, from, to, opts) => {\n      if (canceled) return cancelToken;\n\n      let [ toWidth, toHeight ] = stages.shift();\n\n      let isLastStage = (stages.length === 0);\n\n      opts = assign({}, opts, {\n        toWidth,\n        toHeight,\n        // only use user-defined quality for the last stage,\n        // use simpler (Hamming) filter for the first stages where\n        // scale factor is large enough (more than 2-3)\n        quality: isLastStage ? opts.quality : Math.min(1, opts.quality)\n      });\n\n      let tmpCanvas;\n\n      if (!isLastStage) {\n        // create temporary canvas\n        tmpCanvas = document.createElement('canvas');\n        tmpCanvas.width  = toWidth;\n        tmpCanvas.height = toHeight;\n      }\n\n      return tileAndResize(from, (isLastStage ? to : tmpCanvas), opts).then(() => {\n        if (isLastStage) return to;\n\n        opts.width = toWidth;\n        opts.height = toHeight;\n        return processStages(stages, tmpCanvas, to, opts);\n      });\n    };\n\n\n    let stages = createStages(\n      opts.width,\n      opts.height,\n      opts.toWidth,\n      opts.toHeight,\n      this.options.tile,\n      destTileBorder\n    );\n\n    return processStages(stages, from, to, opts);\n  });\n};\n\n// RGBA buffer resize\n//\nPica.prototype.resizeBuffer = function (options) {\n  const opts = assign({}, DEFAULT_RESIZE_OPTS, options);\n\n  return this.init()\n    .then(() => this.__mathlib.resizeAndUnsharp(opts));\n};\n\n\nPica.prototype.toBlob = function (canvas, mimeType, quality) {\n  mimeType = mimeType || 'image/png';\n\n  return new Promise(resolve => {\n    if (canvas.toBlob) {\n      canvas.toBlob(blob => resolve(blob), mimeType, quality);\n      return;\n    }\n\n    // Fallback for old browsers\n    const asString = atob(canvas.toDataURL(mimeType, quality).split(',')[1]);\n    const len      = asString.length;\n    const asBuffer = new Uint8Array(len);\n\n    for (let i = 0; i < len; i++) {\n      asBuffer[i] = asString.charCodeAt(i);\n    }\n\n    resolve(new Blob([ asBuffer ], { type: mimeType }));\n  });\n};\n\n\nPica.prototype.debug = function () {};\n\n\nmodule.exports = Pica;\n","import exif from \"./exif.js\";\nconst pica = require(\"pica\")();\nconst imageService = {\n  resize: (img, width, height, callback) => {\n    let canvas = document.createElement(\"canvas\");\n    canvas.width = width;\n    canvas.height = height;\n    pica\n      .resize(img, canvas)\n      .then(res => pica.toBlob(res, \"image/jpeg\", 0.9))\n      .then(blob => callback(blob));\n  },\n  handleImage: (source, callback) => {\n    let fileSize = source.size;\n    try {\n      // don't use image reduction for iOS as it's problematic.\n      // TODO: Find a fix and test those platforms.\n      let iOS =\n        /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n      if (iOS) {\n        console.warn(\"Do not use image reduction on iOS !\");\n        callback(source);\n        return;\n      }\n      if (!source.type || !source.type.match(/image/)) {\n        console.warn(\"Do not use image reduction on invalid file !\");\n        callback(source);\n        return;\n      }\n      if (source.type == \"image/gif\") {\n        console.warn(\"Do not use image reduction on a gif !\");\n        callback(source);\n        return;\n      }\n      if (fileSize < 1024 * 1024) {\n        console.warn(\"Do not use image reduction on small file !\");\n        callback(source);\n        return;\n      }\n      exif.getOrientation(source, orientation => {\n        if (orientation != 1 && orientation != 2) {\n          console.warn(\"Incorrect orientation !\");\n          callback(source);\n          return;\n        }\n        let img = new Image();\n        img.onload = () => {\n          let w = Math.min(img.naturalWidth, 2048);\n          // height is not limited to accomodate with long format images\n          // example: https://imgs.xkcd.com/comics/earth_temperature_timeline.png\n          let h = img.naturalHeight; //Math.min(img.naturalHeight, 2048);\n          let g = Math.min(w / img.naturalWidth, h / img.naturalHeight);\n          let nw = Math.floor(img.naturalWidth * g);\n          let nh = Math.floor(img.naturalHeight * g);\n          imageService.resize(img, nw, nh, blob => {\n            callback(blob);\n          });\n        };\n        img.src = URL.createObjectURL(source);\n      });\n    } catch (error) {\n      console.warn(error); // error logging\n      // If something goes wrong in image reduction, fall back to normal upload\n      callback(source);\n    }\n  }\n};\nexport default imageService;\n"]}